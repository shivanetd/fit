{% extends "base.html" %}

{% block title %}Progress - FitTracker{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">
                <i data-feather="trending-up" class="me-2"></i>Your Progress
            </h1>
            <p class="text-muted">Track your fitness journey and see how far you've come</p>
        </div>
    </div>
    
    <!-- Chart Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Chart Type</label>
                    <select class="form-select" id="chartType">
                        <option value="monthly">Monthly Workouts</option>
                        <option value="exercise">Exercise Progress</option>
                    </select>
                </div>
                <div class="col-md-6" id="exerciseSelectContainer" style="display: none;">
                    <label class="form-label">Select Exercise</label>
                    <select class="form-select" id="exerciseSelect">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Charts -->
    <div class="row g-4">
        <!-- Monthly Progress Chart -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="chartTitle">Monthly Workout Frequency</h5>
                </div>
                <div class="card-body">
                    <canvas id="progressChart" height="100"></canvas>
                    <div id="noDataMessage" class="text-center py-5" style="display: none;">
                        <i data-feather="bar-chart-2" class="text-muted mb-3" style="width: 48px; height: 48px;"></i>
                        <h5 class="text-muted">No workout data available</h5>
                        <p class="text-muted">Complete some workouts to see your progress here!</p>
                        <a href="{{ url_for('main_routes.dashboard') }}" class="btn btn-primary">
                            <i data-feather="play" class="me-1"></i>Start a Workout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Stats -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Stats</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i data-feather="calendar" class="text-primary me-3"></i>
                        <div>
                            <h6 class="mb-0">This Week</h6>
                            <span class="text-muted" id="thisWeekCount">0 workouts</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <i data-feather="zap" class="text-warning me-3"></i>
                        <div>
                            <h6 class="mb-0">Current Streak</h6>
                            <span class="text-muted" id="currentStreak">0 days</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <i data-feather="trophy" class="text-success me-3"></i>
                        <div>
                            <h6 class="mb-0">Best Month</h6>
                            <span class="text-muted" id="bestMonth">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Motivation Card -->
            <div class="card">
                <div class="card-body">
                    <img src="https://pixabay.com/get/g77f717a168bb9684a6c2a464dd00541fc8829d2111db8def5cbfd19eb4840c939d9fc36d8b0dacd5dad1053faa0c99023e6ba56ef9f015dfd6b7e3f127c2c9bd_1280.jpg" 
                         class="card-img-top mb-3" alt="Motivation" style="height: 150px; object-fit: cover;">
                    <h6 class="card-title">Keep Going!</h6>
                    <p class="card-text small text-muted">
                        Consistency is key to achieving your fitness goals. Every workout counts!
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const monthlyData = {{ monthly_data | safe }};
    const exerciseData = {{ exercise_data | safe }};
    let currentChart = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        updateStats();
        
        // Chart type change handler
        document.getElementById('chartType').addEventListener('change', function() {
            const chartType = this.value;
            const exerciseContainer = document.getElementById('exerciseSelectContainer');
            
            if (chartType === 'exercise') {
                populateExerciseSelect();
                exerciseContainer.style.display = 'block';
            } else {
                exerciseContainer.style.display = 'none';
                showMonthlyChart();
            }
        });
        
        // Exercise selection handler
        document.getElementById('exerciseSelect').addEventListener('change', function() {
            const exerciseKey = this.value;
            if (exerciseKey) {
                showExerciseChart(exerciseKey);
            }
        });
    });
    
    function initializeCharts() {
        if (Object.keys(monthlyData).length === 0) {
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('progressChart').style.display = 'none';
        } else {
            showMonthlyChart();
        }
    }
    
    function showMonthlyChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        const labels = Object.keys(monthlyData).sort();
        const data = labels.map(label => monthlyData[label]);
        
        document.getElementById('chartTitle').textContent = 'Monthly Workout Frequency';
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(label => {
                    const date = new Date(label + '-01');
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                }),
                datasets: [{
                    label: 'Workouts Completed',
                    data: data,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    function populateExerciseSelect() {
        const select = document.getElementById('exerciseSelect');
        select.innerHTML = '<option value="">Select an exercise</option>';
        
        Object.keys(exerciseData).forEach(exerciseKey => {
            const option = document.createElement('option');
            option.value = exerciseKey;
            option.textContent = exerciseKey.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            select.appendChild(option);
        });
    }
    
    function showExerciseChart(exerciseKey) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        const data = exerciseData[exerciseKey] || [];
        const labels = data.map(item => new Date(item.date).toLocaleDateString());
        const volumes = data.map(item => item.volume);
        
        document.getElementById('chartTitle').textContent = 
            `${exerciseKey.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())} Progress`;
        
        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Volume (reps Ã— weight)',
                    data: volumes,
                    borderColor: 'rgba(118, 75, 162, 1)',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function updateStats() {
        // Calculate this week's workouts
        const thisWeek = calculateThisWeekWorkouts();
        document.getElementById('thisWeekCount').textContent = `${thisWeek} workouts`;
        
        // Calculate current streak
        const streak = calculateCurrentStreak();
        document.getElementById('currentStreak').textContent = `${streak} days`;
        
        // Find best month
        const bestMonth = findBestMonth();
        document.getElementById('bestMonth').textContent = bestMonth;
    }
    
    function calculateThisWeekWorkouts() {
        // This would be calculated from actual workout session data
        // For now, return a placeholder
        return 0;
    }
    
    function calculateCurrentStreak() {
        // This would be calculated from actual workout session data
        // For now, return a placeholder
        return 0;
    }
    
    function findBestMonth() {
        if (Object.keys(monthlyData).length === 0) return '-';
        
        const maxWorkouts = Math.max(...Object.values(monthlyData));
        const bestMonthKey = Object.keys(monthlyData).find(key => monthlyData[key] === maxWorkouts);
        
        if (bestMonthKey) {
            const date = new Date(bestMonthKey + '-01');
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        }
        
        return '-';
    }
</script>
{% endblock %}
